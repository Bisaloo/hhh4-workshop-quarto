<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.415">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Johannes Bracher">

<title>hhh4 workshop - Tutorial, part 2 - Step-by-step development of multivariate hhh4 models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">hhh4 workshop</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">Home</a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="button" data-bs-toggle="dropdown" aria-expanded="false">Tutorials</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../tutorials/introduction.html">
 <span class="dropdown-text">Tutorial 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/multivariate.html">
 <span class="dropdown-text">Tutorial 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/covariate.qmd">
 <span class="dropdown-text">Tutorial 3</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-applications" role="button" data-bs-toggle="dropdown" aria-expanded="false">Applications</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-applications">    
        <li>
    <a class="dropdown-item" href="../applications/session1.html">
 <span class="dropdown-text">Session 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../applications/session2.html">
 <span class="dropdown-text">Session 2</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/bisaloo/hhh4-workshop-quarto"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Tutorial, part 2 - Step-by-step development of multivariate hhh4 models</h1>
</div>





<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Johannes Bracher </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<section id="whats-the-plan" class="level2">
<h2 class="anchored" data-anchor-id="whats-the-plan">What’s the plan?</h2>
<p>In this part of the tutorial you will learn how to build multivariate hhh4 models. We will proceed as follows:</p>
<ul>
<li>I will talk you through an example analysis of norovirus in the twelve districts of Berlin, adding complexity to an hhh4 model step by step.</li>
<li>Then you will be able to use the code chunks from my example to analyse a data set on rotavirus in Berlin which has exactly the same structure as the norovirus data.</li>
<li>We’ll try to be available for questions while you are working on your analysis (as time and the number of participants permits).</li>
<li>If time permits we will go through some of your work at the end.</li>
<li><em>We are using these teaching materials for the first time, so they are likely to contain some errors and bugs – don’t hesitate to ask if something seems puzzling.</em></li>
</ul>
</section>
<section id="repetition-installing-packages" class="level2">
<h2 class="anchored" data-anchor-id="repetition-installing-packages">Repetition: Installing packages</h2>
<p>We require the packages <code>surveillance</code> and <code>hhh4addon</code>, the latter containing some additional functionality for hhh4 models. It can be installed directly from GitHub using the <code>remotes</code> package (you may already have done that for the first part of the tutorial, but the necessary code is included here to make this document self-contained).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># options(warn = -1)</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(surveillance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: sp</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: xtable</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is surveillance 1.20.0. For overview type 'help(surveillance)'.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to install hhh4addon</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("remotes")</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># library(remotes)</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes:::install_github("jbracher/hhh4addon", build_vignettes = TRUE)</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hhh4addon)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: polyCub</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is a development version of hhh4addon. It modifies and extends functionalities of surveillance:hhh4.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'hhh4addon'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:surveillance':

    decompose.hhh4</code></pre>
</div>
</div>
</section>
<section id="example-data" class="level2">
<h2 class="anchored" data-anchor-id="example-data">Example data</h2>
<p>We will use two data sets provided with the <code>hhh4addon</code> package (original data from Robert Koch Institute). The <code>noroBE</code> data contain weekly counts confirmed of norovirus cases in the twelve districts of Berlin, 2011–2017. The <code>rotaBE</code> data contain the same for rotavirus. In this note the norovirus data are analysed, which as an exercise you will be able to apply to the rotavirus data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the data</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"noroBE"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># if you don't have the hhh4addon package installed you can use:</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># load(</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   url("https://github.com/cmmid/hhh4-workshop/blob/main/tutorial2_multivariate/data/noroBE.rda?raw=true")</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We start by plotting the temporal and spatial distribution of the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># look at data:</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># time series:</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(noroBE, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">40</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/%3Cdescription-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># map:</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as population(noroBE) contains population fractions rather than raw</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># population sizes setting population = 100,000/&lt;population of Berlin&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># will yield cumulative incidence per 100,000 inhabitants; see ?stsplot_space</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(noroBE, observed <span class="sc">~</span> unit, <span class="at">population =</span> <span class="dv">100000</span><span class="sc">/</span><span class="dv">3500000</span>, <span class="at">labels =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/%3Cdescription-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We moreover take a look at the slot <code>neighbourhood</code> of the <code>sts</code> object. In this case it contains path distances between the districts: e.g., <code>chwi</code> and <code>frkr</code> have a distance of 2 as you need to go through <code>mitt</code> or <code>scho</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check the neighbourhood structure, which is stored in the @neighbourhood slot </span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># of the sts object:</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>noroBE<span class="sc">@</span>neighbourhood</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     chwi frkr lich mahe mitt neuk pank rein span zehl scho trko
chwi    0    2    3    4    1    2    2    1    1    1    1    3
frkr    2    0    1    2    1    1    1    2    3    2    1    1
lich    3    1    0    1    2    2    1    2    3    3    2    1
mahe    4    2    1    0    3    2    2    3    4    4    3    1
mitt    1    1    2    3    0    2    1    1    2    2    1    2
neuk    2    1    2    2    2    0    2    3    3    2    1    1
pank    2    1    1    2    1    2    0    1    2    3    2    2
rein    1    2    2    3    1    3    1    0    1    2    2    3
span    1    3    3    4    2    3    2    1    0    1    2    4
zehl    1    2    3    4    2    2    3    2    1    0    1    3
scho    1    1    2    3    1    1    2    2    2    1    0    2
trko    3    1    1    1    2    1    2    3    4    3    2    0</code></pre>
</div>
</div>
</section>
<section id="developing-a-multivariate-model-step-by-step" class="level2">
<h2 class="anchored" data-anchor-id="developing-a-multivariate-model-step-by-step">Developing a multivariate model step by step</h2>
<section id="step-1-seasonality-in-the-endemic-component-all-parameters-shared." class="level3">
<h3 class="anchored" data-anchor-id="step-1-seasonality-in-the-endemic-component-all-parameters-shared.">Step 1: Seasonality in the endemic component, all parameters shared.</h3>
<p>We start by formulating a very simple model where for districts <span class="math inline">\(i = 1, \dots, K\)</span> we assume <span class="math display">\[\begin{align}
Y_{it} \ \mid \ \ \text{past} &amp; \sim \text{NegBin}(\mu_{it}, \psi)\\
\mu_{it} &amp; = \nu_t + \lambda Y_{i, t - 1}
\end{align}\]</span> and</p>
<p><span class="math display">\[
\nu_{t} = \alpha^\nu + \beta^\nu \sin(2\pi t/52) + \gamma^\nu \cos(2\pi t/52).
\]</span></p>
<p>Reminder: we refer to</p>
<ul>
<li><span class="math inline">\(\nu_t\)</span> as the endemic component</li>
<li><span class="math inline">\(\lambda Y_{i, t - 1}\)</span> as the autoregressive or epidemic component</li>
</ul>
<p>In a setting with just three districts the model could be illustrated as follows – case numbers the different districts are independent and only depend on the previous value in the same district.</p>
<p><img src="tutorial_files/figure-html/model1.png" class="img-fluid"></p>
<p>In <code>surveillance</code> this model is specified as follows. Reminder: The <code>hhh4</code> function takes the following arguments:</p>
<ul>
<li>an <code>sts</code>object containing the data</li>
<li>a <code>control</code> argument describing the model formulation. This list contains a number of named arguments, the most important ones being:
<ul>
<li><code>end</code>: a specification of the endemic component (i.e., <span class="math inline">\(\nu\)</span>).</li>
<li><code>ar</code>: a specification of the autoregressive component (<span class="math inline">\(\lambda\)</span>; dependence on the previous value from the same district).</li>
<li><code>ne</code>: a specification of the neighbourhood component (<span class="math inline">\(\phi\)</span>; dependence on on previous value from other districts, to be introduced later). All of <code>end</code>, <code>ar</code> and <code>ne</code> are lists containing a formula and possibly some more elements, see <code>?hhh4</code></li>
<li><code>family</code>: the type of distribution used in the recursive model formulation (either <code>"Poisson"</code>, <code>"NegBin1"</code>, or <code>"NegBinM"</code>).</li>
<li><code>subset</code>: The subset of the time series to which the model shall be fit.</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first define a subset of the data to which to fit (will be used in all model</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fits to ensure comparability of AIC values):</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>subset_fit <span class="ot">&lt;-</span> <span class="dv">6</span><span class="sc">:</span>(<span class="fu">nrow</span>(noroBE<span class="sc">@</span>observed) <span class="sc">-</span> <span class="dv">52</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># we are leaving out the last year and the first 5 observations</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># the latter serves to ensure comparability to later model versions</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 1:</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># control list:</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>ctrl1 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">end =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="fu">addSeason2formula</span>(<span class="sc">~</span><span class="dv">1</span>, <span class="at">S =</span> <span class="dv">1</span>)), <span class="co"># seasonality in end</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>              <span class="co"># S = 1 means one pair of sine / cosine waves is included</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">ar =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="sc">~</span> <span class="dv">1</span>), <span class="co"># no seasonality in ar</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">"NegBin1"</span>, <span class="co"># negative binomial (rather than Poisson)</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">subset =</span> subset_fit)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">hhh4</span>(noroBE, ctrl1)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co"># summary of parameter estimates:</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: 
hhh4(stsObj = noroBE, control = ctrl1)

Coefficients:
                        Estimate  Std. Error
ar.1                    -0.72854   0.03453  
end.1                    0.84477   0.02860  
end.sin(2 * pi * t/52)   0.09024   0.02806  
end.cos(2 * pi * t/52)   0.88574   0.02856  
overdisp                 0.22957   0.01076  

Log-likelihood:   -8780.82 
AIC:              17571.64 
BIC:              17602.7 

Number of units:        12 
Number of time points:  307 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># you can set idx2Exp = TRUE to get all estimates on the exp-transformed scale</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1, <span class="at">idx2Exp =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: 
hhh4(stsObj = noroBE, control = ctrl1)

Coefficients:
                             Estimate  Std. Error
exp(ar.1)                    0.48261   0.01667   
exp(end.1)                   2.32745   0.06657   
exp(end.sin(2 * pi * t/52))  1.09443   0.03071   
exp(end.cos(2 * pi * t/52))  2.42477   0.06925   
overdisp                     0.22957   0.01076   

Log-likelihood:   -8780.82 
AIC:              17571.64 
BIC:              17602.7 

Number of units:        12 
Number of time points:  307 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get AIC to compare model fit to more complex models</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(fit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17571.64</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visually inspect:</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">2</span>))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit1, <span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="at">par.settings =</span> <span class="fu">list</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">2</span>))) <span class="co"># look at all units</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/fit1-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># par.settings = list(mfcol = c(6, 2)) tells the function we want two columns</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># of plots</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The grey area represents the endemic component (<span class="math inline">\(\nu_{t}\)</span>) of the fitted values with clearly visible seasonality. The blue area represents the autoregressive component.</p>
<p>For model inspection I like looking at Pearson residuals</p>
<p><span class="math display">\[
\frac{Y_{it} - \hat{\mu}_{it}}{\hat{\sigma}_{it}} = \frac{Y_{it} - \hat{\mu}_{it}}{\sqrt{\hat{\mu}_{it} + \hat{\mu}_{it}^2/\psi}},
\]</span></p>
<p>which are not currently implemented in <code>surveillance</code>, but can be computed using a little auxiliary function. For now I just look at their mean and variance per district.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># helper function to compute Pearson residuals:</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>pearson_residuals <span class="ot">&lt;-</span> <span class="cf">function</span>(hhh4Obj){</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute raw residuals:</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  response_residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(hhh4Obj, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute standard deviations:</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(hhh4Obj, <span class="st">"hhh4lag"</span>)) {</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    sds <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">fitted</span>(hhh4Obj) <span class="sc">+</span> </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">fitted</span>(hhh4Obj)<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>hhh4addon<span class="sc">:::</span><span class="fu">psi2size.hhh4lag</span>(hhh4Obj))</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    sds <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">fitted</span>(hhh4Obj) <span class="sc">+</span> </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">fitted</span>(hhh4Obj)<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>surveillance<span class="sc">:::</span><span class="fu">psi2size.hhh4</span>(hhh4Obj))</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute Pearson residuals:</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  pearson_residuals <span class="ot">&lt;-</span> response_residuals<span class="sc">/</span>sds</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pearson_residuals)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>pr1 <span class="ot">&lt;-</span> <span class="fu">pearson_residuals</span>(fit1)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="co"># compute district-wise means and standard deviations:</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="fu">colMeans</span>(pr1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        chwi         frkr         lich         mahe         mitt         neuk 
-0.040128818 -0.354497174 -0.026596771 -0.149654100 -0.098957012 -0.139634691 
        pank         rein         span         zehl         scho         trko 
 0.363677331 -0.006394507 -0.203281407  0.422776136  0.208763434 -0.023204469 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(pr1, <span class="dv">2</span>, sd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     chwi      frkr      lich      mahe      mitt      neuk      pank      rein 
0.8969573 0.8394516 0.9984702 0.9348625 0.9594755 0.8998828 1.1386447 0.9955265 
     span      zehl      scho      trko 
0.9606598 1.2538557 1.0589218 0.9730101 </code></pre>
</div>
</div>
<p>In each district, the Pearson residuals should have mean and standard deviations of approximately 0 and 1, respectively, which is clearly not the case. By sharing all parameters, fitted values are systematically larger than observed in some districts and smaller in others.</p>
</section>
<section id="adding-district-specific-parameters." class="level3">
<h3 class="anchored" data-anchor-id="adding-district-specific-parameters.">Adding district-specific parameters.</h3>
<p>As the districts are of quite different sizes and have different levels of incidence, it seems reasonable to use district-specific parameters and extend the model to <span class="math display">\[\begin{align}
Y_{it} \ \mid \ \ \text{past} &amp; \sim \text{NegBin}(\mu_{it}, \psi)\\
\mu_{it} &amp; = \nu_{it} + \lambda_i Y_{i, t - 1}\\
\nu_{it} &amp; = \alpha^\nu_i + \beta^\nu \sin(2\pi t/52) + \gamma^\nu \cos(2\pi t/52)
\end{align}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2:</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We use fe(..., unitSpecific = TRUE) to add fixed effects for each unit,</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># in this case intercepts (1). Seasonality parameters are still shared</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># across districts</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>ctrl2 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">end =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="fu">addSeason2formula</span>(<span class="sc">~</span><span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">S =</span> <span class="dv">1</span>)),</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">ar =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">"NegBin1"</span>,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">subset =</span> subset_fit)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: ~0 is necessary as otherwise one would (implicitly) add two intercepts</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="co"># unit-specific dispersion parameters could be added by setting family = "NegBinM"</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">hhh4</span>(noroBE, ctrl2)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="co"># check parameter estimates:</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: 
hhh4(stsObj = noroBE, control = ctrl2)

Coefficients:
                        Estimate   Std. Error
ar.1.chwi               -1.795086   0.402460 
ar.1.frkr               -1.259748   0.182296 
ar.1.lich               -1.087080   0.177651 
ar.1.mahe               -0.957952   0.145501 
ar.1.mitt               -1.335034   0.214060 
ar.1.neuk               -0.967629   0.159855 
ar.1.pank               -0.753360   0.129017 
ar.1.rein               -0.668191   0.103620 
ar.1.span               -0.823339   0.125950 
ar.1.zehl               -0.659794   0.095464 
ar.1.scho               -0.865145   0.132413 
ar.1.trko               -1.002428   0.165175 
end.sin(2 * pi * t/52)   0.121489   0.024384 
end.cos(2 * pi * t/52)   0.923900   0.024745 
end.1.chwi               1.181472   0.088438 
end.1.frkr               0.604251   0.081671 
end.1.lich               1.020524   0.089385 
end.1.mahe               0.791906   0.089509 
end.1.mitt               1.010631   0.081603 
end.1.neuk               0.823126   0.097049 
end.1.pank               1.298509   0.104632 
end.1.rein               0.791816   0.097056 
end.1.span               0.648208   0.092789 
end.1.zehl               1.297808   0.091415 
end.1.scho               1.189950   0.093128 
end.1.trko               0.997664   0.094204 
overdisp                 0.197678   0.009884 

Log-likelihood:   -8655.46 
AIC:              17364.92 
BIC:              17532.63 

Number of units:        12 
Number of time points:  307 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute AIC</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17364.92</code></pre>
</div>
</div>
<p>We check the Pearson residuals again, which now look resonable in terms of mean and variance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute Pearson residuals and check their mean and variance:</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>pr2 <span class="ot">&lt;-</span> <span class="fu">pearson_residuals</span>(fit2)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colMeans</span>(pr2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        chwi         frkr         lich         mahe         mitt         neuk 
 0.020061368  0.025144794 -0.010413219  0.003481020 -0.004801394 -0.006139166 
        pank         rein         span         zehl         scho         trko 
-0.012998766 -0.004079849 -0.001710578 -0.022435249 -0.007614639 -0.016314666 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(pr1, <span class="dv">2</span>, sd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     chwi      frkr      lich      mahe      mitt      neuk      pank      rein 
0.8969573 0.8394516 0.9984702 0.9348625 0.9594755 0.8998828 1.1386447 0.9955265 
     span      zehl      scho      trko 
0.9606598 1.2538557 1.0589218 0.9730101 </code></pre>
</div>
</div>
<p>Note that we could also add district-specific dispersion parameters <span class="math inline">\(\psi_i\)</span> by setting <code>family = "NegBinM"</code>, but for simplicity we stick with the shared overdispersion parameter.</p>
</section>
<section id="adding-dependence-between-districts." class="level3">
<h3 class="anchored" data-anchor-id="adding-dependence-between-districts.">Adding dependence between districts.</h3>
<p>For now we have been modelling each district separately (while sharing some strength by pooling parameters). In a next step we add dependencies via the <code>ne</code> (neighbourhood) component. There are different ways of specifying the coupling between districts. The <code>neighbourhood</code> slot of the <code>sts</code> object contains the necessary information on the geographical disposition.</p>
<p>We now fit a model where only direct neighbours affect each other, setting <span class="math display">\[\begin{align}
Y_{it} \ \mid \ \ \text{past} &amp; \sim \text{NegBin}(\mu_{it}, \psi)\\
\mu_{it} &amp; = \nu_{it} + \lambda_i Y_{i, t - 1} + \phi_i \sum_{j \sim i} w_{ji} Y_{j, t - 1}.
\end{align}\]</span> Here, the relationship <span class="math inline">\(\sim\)</span> indicates direct neighbourhood. The weights <span class="math inline">\(w_{ji}\)</span> can be chosen in two ways.</p>
<ul>
<li>if <code>normalize == TRUE</code>: <span class="math inline">\(w_{ji} = 1/\)</span> number of neighbours of <span class="math inline">\(j\)</span> if <span class="math inline">\(i \sim j\)</span>, 0 else</li>
<li>if <code>normalize == FALSE</code>: <span class="math inline">\(w_{ji} = 1\)</span> if <span class="math inline">\(i \sim j\)</span>, 0 else</li>
</ul>
<p>We usually use <code>normalize = TRUE</code>, which is based on the intuition that each district splits up its infectious pressure equally among its neighbours. Note that in this formulation, the autoregression on past incidence from the same district and others are handled each on their own with separate parameters.</p>
<p>In a simple graphical ilustration with just three districts where district 2 is neighbouring both 1 and 3, but 1 and 3 are not neighbours, the model looks as follows. The grey lines indicate that these dependencies are typically weaker than the ones to previous values from the same district.</p>
<p><img src="tutorial_files/figure-html/model2.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The default setting for the ne component is to use weights </span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># neighbourhood(stsObj) == 1 (see ?hhh4).</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">neighbourhood</span>(noroBE) <span class="sc">==</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      chwi  frkr  lich  mahe  mitt  neuk  pank  rein  span  zehl  scho  trko
chwi FALSE FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE  TRUE  TRUE FALSE
frkr FALSE FALSE  TRUE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE  TRUE  TRUE
lich FALSE  TRUE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE
mahe FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE
mitt  TRUE  TRUE FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE FALSE  TRUE FALSE
neuk FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE
pank FALSE  TRUE  TRUE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE
rein  TRUE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE  TRUE FALSE FALSE FALSE
span  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE
zehl  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE
scho  TRUE  TRUE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE FALSE
trko FALSE  TRUE  TRUE  TRUE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this is because historically neighbourhood matrices were just binary</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># however, the path distances are coded in a way that direct neighbours have </span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># distance 1, meaning that there is no need to modify the neighbourhood matrix</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 3:</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>ctrl3 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">end =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="fu">addSeason2formula</span>(<span class="sc">~</span><span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">S =</span> <span class="dv">1</span>)),</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">ar =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">ne =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>), <span class="at">normalize =</span> <span class="cn">TRUE</span>), </span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>              <span class="co">#  now added ne component to reflect cross-district dependencies</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">"NegBin1"</span>,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">subset =</span> subset_fit)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co"># normalize = TRUE normalizes weights by the number of neighbours of the </span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co"># exporting district</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">hhh4</span>(noroBE, ctrl3)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co"># alternative: use update</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co"># fit3 &lt;- update(fit2, ne = list(f = ~ 0 + fe(1, unitSpecific = TRUE),</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co">#                                weights = neighbourhood(noroBE) == 1,  # little bug?</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="co">#                                normalize = TRUE))</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit3) <span class="co"># parameters for different districts are quite different</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: 
hhh4(stsObj = noroBE, control = ctrl3)

Coefficients:
                        Estimate   Std. Error
ar.1.chwi               -2.984424   1.350606 
ar.1.frkr               -1.546018   0.255272 
ar.1.lich               -1.481704   0.269704 
ar.1.mahe               -1.042180   0.165513 
ar.1.mitt               -1.684145   0.325195 
ar.1.neuk               -1.178880   0.203516 
ar.1.pank               -0.950771   0.162474 
ar.1.rein               -0.739190   0.113666 
ar.1.span               -1.030189   0.159685 
ar.1.zehl               -0.700978   0.109133 
ar.1.scho               -1.140107   0.188365 
ar.1.trko               -0.954548   0.156077 
ne.1.chwi               -1.556838   0.229854 
ne.1.frkr               -2.105432   0.303360 
ne.1.lich               -1.333358   0.275089 
ne.1.mahe               -2.082596   1.001100 
ne.1.mitt               -1.382118   0.285452 
ne.1.neuk               -1.005697   0.308230 
ne.1.pank               -0.594043   0.265078 
ne.1.rein               -1.531222   0.365439 
ne.1.span               -1.496264   0.237766 
ne.1.zehl               -1.197674   0.519991 
ne.1.scho               -1.174415   0.268474 
ne.1.trko               -2.805666   1.088384 
end.sin(2 * pi * t/52)   0.013954   0.037300 
end.cos(2 * pi * t/52)   0.918633   0.033880 
end.1.chwi               0.817175   0.143907 
end.1.frkr               0.142450   0.200990 
end.1.lich               0.636253   0.176280 
end.1.mahe               0.715465   0.135111 
end.1.mitt               0.541823   0.187192 
end.1.neuk               0.444922   0.175794 
end.1.pank               0.867238   0.188664 
end.1.rein               0.349285   0.222273 
end.1.span               0.143326   0.183118 
end.1.zehl               1.068714   0.140279 
end.1.scho               0.730291   0.182337 
end.1.trko               0.866186   0.143240 
overdisp                 0.182920   0.009464 

Log-likelihood:   -8596.56 
AIC:              17271.12 
BIC:              17513.37 

Number of units:        12 
Number of time points:  307 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(fit3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17271.12</code></pre>
</div>
</div>
<p>Plotting the model fits, we see that for certain districts the neighbourhood component (orange) is very important (<code>chwi</code>), for others negligible (<code>trko</code>). This may be due to poor identifiability (after all, the autoregressive terms from the same and other districts are strongly correlated).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit3, <span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="at">par.settings =</span> <span class="fu">list</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/plot3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="adding-a-power-law-for-spatial-dependence." class="level3">
<h3 class="anchored" data-anchor-id="adding-a-power-law-for-spatial-dependence.">Adding a power law for spatial dependence.</h3>
<p>The above formulation requires a lot of parameters as the autoregressions on the same and other regions are handled separately, and only takes into account first neighbours. A more parsimonious model also alowing for dependencies between indirect neighbours is a power-law formulation, where we set <span class="math display">\[\begin{align}
\mu_{it} &amp; = \nu_{it} + \phi_i \sum_{j = 1}^K w_{ji} Y_{j, t - 1}
\end{align}\]</span> with weights <span class="math inline">\(w_{ji}\)</span> defined as</p>
<p><span class="math display">\[
w_{ji} = \begin{cases} (o_{ji} + 1)^{-\rho} &amp; \text{ if } \text{normalize == FALSE}\\
\frac{(o_{ji} + 1)^{-\rho}}{\sum_{i = 1}^K (o_{jk} + 1)^{-\rho}}  &amp; \text{ if } \text{normalize == TRUE} \end{cases},
\]</span></p>
<p>where <span class="math inline">\(o_{ji}\)</span> is the path distance between districts <span class="math inline">\(j\)</span> and <span class="math inline">\(i\)</span>.</p>
<p>Returning to our simple illustration with three districts, this step adds some additional connections between indirect neighbours (districts 1 and 3). They are shown in light gray as by construction of the model they are weaker than those between neighbouring districts.</p>
<p><img src="tutorial_files/figure-html/model3.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 4</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># For the next model version we will formally incorporate the autoregressive</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co"># copoenent into the neighbourhood component</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># (i.e. do no longer treat autoregression on the same district separately). </span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co"># This can be done as follows.</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co"># First we need to adapt the neighbourhood matrix, shifting by one</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>noroBE_power <span class="ot">&lt;-</span> noroBE</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>noroBE_power<span class="sc">@</span>neighbourhood <span class="ot">&lt;-</span> noroBE<span class="sc">@</span>neighbourhood <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="co"># new control argument:</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>ctrl4 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">end =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="fu">addSeason2formula</span>(<span class="sc">~</span><span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">S =</span> <span class="dv">1</span>)),</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>              <span class="co"># note: line ar = ... is removed</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">ne =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="sc">~</span><span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>                        <span class="at">weights =</span> <span class="fu">W_powerlaw</span>(<span class="at">maxlag=</span><span class="dv">5</span>, <span class="at">normalize =</span> <span class="cn">TRUE</span>,</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">log =</span> <span class="cn">TRUE</span>)), <span class="co"># this is new</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">"NegBin1"</span>,</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>              <span class="at">subset =</span> subset_fit)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span class="co"># normalize = TRUE normalizes weights by the number of neighbours of the</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="co"># exporting district</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="co"># log = TRUE means optimization will be done on a log scale, ensuring </span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span class="co"># positivity of the decay parameter (which is desirable)</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>fit4 <span class="ot">&lt;-</span> <span class="fu">hhh4</span>(noroBE_power, ctrl4)</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(fit4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17233.06</code></pre>
</div>
</div>
<p>This yields a quite drastic improvement in AIC. We can visualize the weights <span class="math inline">\(w_{ji}\)</span> as a function of the path dependence <span class="math inline">\(o_{ji}\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the nighbourhood weights:</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit4, <span class="at">type =</span> <span class="st">"neweights"</span>, <span class="at">main =</span> <span class="st">"Weights by path distance</span><span class="sc">\n</span><span class="st"> (note: 1 is same region and 2 is direct neighbours here)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/neweights-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>When plotting the model fit we note that there is now no autoregressive component (blue).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit4, <span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="at">par.settings =</span> <span class="fu">list</span>(<span class="at">mfcol =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/plot4b-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># note there is now no autoregressive component in the fit plots</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="adding-seasonality-to-the-epidemic-component." class="level3">
<h3 class="anchored" data-anchor-id="adding-seasonality-to-the-epidemic-component.">Adding seasonality to the epidemic component.</h3>
<p>Including seasonality in the <code>ar</code> and <code>ne</code> components when both are present can lead to identifiability issues. In the more parsimonious model where only the <code>ne</code> component is present, however, including seasonal terms here can considerably improve the model fit. This is indeed the case in our example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 5:</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>ctrl5 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">end =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="fu">addSeason2formula</span>(<span class="sc">~</span><span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">S =</span> <span class="dv">1</span>)),</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>              <span class="co"># now adding seasonality to the ne component:</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">ne =</span> <span class="fu">list</span>(<span class="at">f =</span>  <span class="fu">addSeason2formula</span>(<span class="sc">~</span><span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>),</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">S =</span> <span class="dv">1</span>),</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">weights =</span> <span class="fu">W_powerlaw</span>(<span class="at">maxlag=</span><span class="dv">5</span>, <span class="at">normalize =</span> <span class="cn">TRUE</span>,</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">log=</span><span class="cn">TRUE</span>)), <span class="co"># this is new</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">"NegBin1"</span>,</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">subset =</span> subset_fit)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>fit5 <span class="ot">&lt;-</span> <span class="fu">hhh4</span>(noroBE_power, ctrl5)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(fit5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17205.41</code></pre>
</div>
</div>
<p>We also consider the autocorrelation of the Pearson residuals. For several regions there are pronounced residual autocorrelations at lags 2 or 3, indicating that there is additional information to be exploited.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute Pearson residuals:</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>pr5 <span class="ot">&lt;-</span> <span class="fu">pearson_residuals</span>(fit4)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(unit <span class="cf">in</span> <span class="fu">colnames</span>(pr5)){</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">acf</span>(pr5[, unit], <span class="at">lag.max =</span> <span class="dv">5</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.3</span>), <span class="at">main =</span> unit)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/pr5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="adding-higher-order-lags." class="level3">
<h3 class="anchored" data-anchor-id="adding-higher-order-lags.">Adding higher-order lags.</h3>
<p>The <code>hhh4addon</code> package contains functionality to add higher-order lags to the endemic-epidemic model,</p>
<p><span class="math display">\[
\mu_{it} = \nu_{it} + \phi_i \sum_{j = 1}^K \sum_{d = 1}^D u_d w_{ji} Y_{j, t - d}.
\]</span></p>
<p>Lag weights are (usually) governed by a single parameter, which is fed into a function returning the weights. The package contains the several parameterizations:</p>
<ul>
<li>geometric: <span class="math inline">\(\tilde{u}_d = \alpha(1 - \alpha)^{d - 1}\)</span></li>
<li>Poisson: <span class="math inline">\(\tilde{u}_d = \alpha^{d - 1}\exp(-\alpha)/(d - 1)!\)</span></li>
</ul>
<p>Before entering into <span class="math inline">\(\eqref{eq:higher_order}\)</span> the lag weights are standardized so they sum up to one, setting <span class="math inline">\(u_d = \tilde{u}_d / \sum_{i = 1}^D \tilde{u}_{i}\)</span>.</p>
<p>Returning a last time to our toy illustration of three districts, this step adds a whole lot of (typically week) connections between non-neighbouring time points.</p>
<p><img src="tutorial_files/figure-html/model4.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check out examples of the different lag types:</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># geometric:</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>(g <span class="ot">&lt;-</span> <span class="fu">geometric_lag</span>(<span class="at">par_lag =</span> <span class="fl">1.5</span>, <span class="at">min_lag =</span> <span class="dv">1</span>, <span class="at">max_lag =</span> <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8177396888 0.1491765911 0.0272136178 0.0049644585 0.0009056439</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first weight corresponds to exp(1.5)/(1 + exp(1.5))</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 is also the default number of lags</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Poisson:</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>(p <span class="ot">&lt;-</span> <span class="fu">poisson_lag</span>(<span class="at">par_lag =</span> <span class="fl">0.8</span>, <span class="at">min_lag =</span> <span class="dv">1</span>, <span class="at">max_lag =</span> <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1168028 0.2599493 0.2892639 0.2145896 0.1193945</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># weights correspond to dpois(0:4, exp(0.8))/sum(dpois(0:4, exp(0.8)))</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(g, <span class="at">xlab =</span> <span class="st">"lag"</span>, <span class="at">ylab =</span> <span class="st">"weight"</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">type =</span> <span class="st">"h"</span>, </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Geometric weights"</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, <span class="at">xlab =</span> <span class="st">"lag"</span>, <span class="at">ylab =</span> <span class="st">"weight"</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">type =</span> <span class="st">"h"</span>, </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Poisson weights"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/lag_types-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A two-point distribution and a triangular distribution are also available.</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Users can also provide their own weighting functions.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The parameterizations of these functions are chosen such that any value from the real line can be provided to them, which will facilitate optimization in a next step</p>
<!-- 
If **fixed** weights for past incidence shall be used, e.g. motivated by a serial interval distribution taken from the literature, the function `hhh4_lag` can be used. As an exampe we use the geometric lag weight distribution from above.

::: {.cell}

```{.r .cell-code}
##################################################################
# Model 6
ctrl6 <- list(end = list(f = addSeason2formula(~0 + fe(1, unitSpecific = TRUE),
                                               S = 1)),
              ne = list(f = addSeason2formula(~0 + fe(1, unitSpecific = TRUE),
                                              S = 1),
                        weights = W_powerlaw(maxlag=5, normalize = TRUE,
                                             log=TRUE)),
              family = "NegBin1",
              subset = subset_fit,
              par_lag = 1.5, # this is new
              funct_lag = geometric_lag) # this is new; geometric_lag is default
fit6 <- hhh4_lag(noroBE_power, ctrl6)
AIC(fit6)
```

::: {.cell-output .cell-output-stdout}
```
[1] 17151.77
```
:::
:::

### Estimating lag weights.

-->
<p>The lag weihts can be pre-specified, but most of the time we will estimate them from the data rather than pre-specifying them. This can be done via the (poorly named) function <code>profile_par_lag</code>. We use geometric lags (which is also the default).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 7</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>ctrl7 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">end =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="fu">addSeason2formula</span>(<span class="sc">~</span><span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>),</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">S =</span> <span class="dv">1</span>)),</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>              <span class="co"># note: line ar = ... is removed</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">ne =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="fu">addSeason2formula</span>(<span class="sc">~</span><span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>),</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">S =</span> <span class="dv">1</span>),</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">weights =</span> <span class="fu">W_powerlaw</span>(<span class="at">maxlag=</span><span class="dv">5</span>, <span class="at">normalize =</span> <span class="cn">TRUE</span>,</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">log=</span><span class="cn">TRUE</span>)), <span class="co"># this is new</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">"NegBin1"</span>,</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">subset =</span> subset_fit,</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>              <span class="co"># (no specification of par_lag in the control)</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">funct_lag =</span> geometric_lag)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="co"># now use profile_par_lag (applies a profile likelihood procedure to estimate</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="co"># the lag decay parameter)</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>fit7 <span class="ot">&lt;-</span> <span class="fu">profile_par_lag</span>(noroBE_power, ctrl6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in profile_par_lag(noroBE_power, ctrl6): Your control list contains a
par_lag element. This is ignored by profile_par_lag. To fix par_lag rather than
estimating it from the data use the function hhh4lag.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(fit7)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17138.12</code></pre>
</div>
</div>
<p>We can plot the weights as estimated from the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the weights assigned to the different lags:</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit7<span class="sc">$</span>distr_lag, <span class="at">type =</span> <span class="st">"h"</span>, <span class="at">xlab  =</span> <span class="st">"lag"</span>,</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"weight"</span>, <span class="at">ylim =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/plot_weights-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And consider the Pearson residuals, which look less problematic than before (at least that’s what I like to tell myself).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check Pearson residuals</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>pr7 <span class="ot">&lt;-</span> <span class="fu">pearson_residuals</span>(fit6)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(unit <span class="cf">in</span> <span class="fu">colnames</span>(pr7)){</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">acf</span>(pr7[, unit], <span class="at">lag.max =</span> <span class="dv">5</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.3</span>), <span class="at">main =</span> unit)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/pr6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="one-step-ahead-forecasting" class="level2">
<h2 class="anchored" data-anchor-id="one-step-ahead-forecasting">One-step-ahead forecasting</h2>
<p>The packages contain functionality to imitate one-step-ahead (out-of-sample) forecasts retrospectively. To this end, the model is sequentially re-fitted, always including all data up to a given week. Then a one-week-ahead plug-in prediciton is obtained for the next week. We apply this to obtain predictions for weeks 313 through 364 which we had excluded from model fitting so far. Subsequently, you can use <code>scores</code> to evaluate the one-step-ahead predictions using several different statistical metrics. We compute the following:</p>
<ul>
<li>the logarithmic score, also called negative predictive log-likelihood (informal explanation: this reflects how likely the observed outcomes were under your predictions)</li>
<li>the CRPS (informal explanation: this describes “how far” the observations were from the predictions you issued)</li>
</ul>
<p>For both <em>lower values</em>` are better.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co"># one-step-ahead forecasting: generate forecasts sequentially</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># compare models 2, 4 and 7</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>log2 <span class="ot">&lt;-</span> <span class="fu">capture.output</span>(owa2 <span class="ot">&lt;-</span> <span class="fu">oneStepAhead</span>(fit2, <span class="at">tp =</span> <span class="fu">c</span>(<span class="dv">312</span>, <span class="dv">363</span>)))</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>log4 <span class="ot">&lt;-</span> <span class="fu">capture.output</span>(owa4 <span class="ot">&lt;-</span> <span class="fu">oneStepAhead</span>(fit4, <span class="at">tp =</span> <span class="fu">c</span>(<span class="dv">312</span>, <span class="dv">363</span>)))</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(log2, log4)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co"># the weird capture.output formulation is needed to suppress </span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co"># numerous cat() messages.</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="co"># you could also just use</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="co"># owa2 &lt;- oneStepAhead(fit2, tp = c(312, 363))</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>owa7 <span class="ot">&lt;-</span> <span class="fu">oneStepAhead_hhh4lag</span>(fit7, <span class="at">tp =</span> <span class="fu">c</span>(<span class="dv">312</span>, <span class="dv">363</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Lag weights are not re-estimated for the one-step-ahead forecasts (set refit_par_lag = TRUE to re-fit them).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the return objects contain predictions, observations and a few other things:</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(owa7<span class="sc">$</span>pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         chwi     frkr      lich     mahe      mitt      neuk     pank     rein
313 10.143891 5.997015  8.315079 7.550797 12.276676  9.072281 18.06990 12.35556
314 10.052363 6.133326  9.568715 7.025105 12.332588 11.455435 20.52966 10.66938
315 10.837813 6.638302 10.085745 8.250180 10.817444 10.246092 22.11388 17.05596
316  9.737658 6.614877 16.126879 8.251785  8.842089  8.346344 24.43109 14.89341
317  8.017484 5.761749 10.387913 6.531485  6.529512  7.030808 20.62327 11.56332
318  9.328702 7.435577 13.008535 6.949797  8.054874  9.280143 20.39342 11.20380
         span     zehl     scho     trko
313 13.161304 20.62583 19.19221 7.951694
314 10.103430 23.18901 18.21469 8.461257
315  8.692397 24.61323 21.20857 8.030405
316  7.391036 19.24499 17.81345 7.817094
317 10.879236 19.91117 14.02415 6.814946
318 11.205468 19.68513 16.13912 8.639782</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(owa7<span class="sc">$</span>observed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    chwi frkr lich mahe mitt neuk pank rein span zehl scho trko
313   10    4   10    5   17   16   23    5    7   24   17    5
314   12    8    9   10    6    8   23   26    3   24   28    3
315   11    7   31    7    3    5   28   14    4   14   18    2
316    5    8    6    5    0    5   22    8   18   20   12    4
317   13   16   20    6    7   11   20    8   14   17   18    6
318    7    8    7    5    3   16    9   20   12   22   31   11</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot one-step-ahead point forecasts:</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(noroBE<span class="sc">@</span>observed[<span class="dv">313</span><span class="sc">:</span><span class="dv">364</span>, <span class="dv">1</span>], <span class="at">pch =</span> <span class="dv">20</span>, <span class="at">xlab =</span> <span class="st">"week"</span>, <span class="at">ylab =</span> <span class="st">"value"</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(owa2<span class="sc">$</span>pred[, <span class="dv">1</span>], <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="dv">2</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(owa4<span class="sc">$</span>pred[, <span class="dv">1</span>], <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="dv">4</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(owa7<span class="sc">$</span>pred[, <span class="dv">1</span>], <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/owa-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute and summarize scores:</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colMeans</span>(<span class="fu">scores</span>(owa2, <span class="at">which =</span> <span class="fu">c</span>(<span class="st">"logs"</span>, <span class="st">"rps"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    logs      rps 
2.506608 2.091024 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colMeans</span>(<span class="fu">scores</span>(owa4, <span class="at">which =</span> <span class="fu">c</span>(<span class="st">"logs"</span>, <span class="st">"rps"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    logs      rps 
2.492431 2.066390 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colMeans</span>(<span class="fu">scores</span>(owa7, <span class="at">which =</span> <span class="fu">c</span>(<span class="st">"logs"</span>, <span class="st">"rps"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    logs      rps 
2.475311 2.042008 </code></pre>
</div>
</div>
<p>We can see that the more complex model formulations also translate to improved predictive performance (all scores being negatively oriented; see <code>?scores</code>).</p>
</section>
<section id="predictive-moments-at-longer-forecast-horizons." class="level2">
<h2 class="anchored" data-anchor-id="predictive-moments-at-longer-forecast-horizons.">Predictive moments at longer forecast horizons.</h2>
<p>The <code>hhh4addon</code> package also contains functions to compute predictive moments (means, variances, autocorrelations) for longer time horizons as well as marginal/stationary moments of the fitted model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="co"># longer-term predictive moments can be computed using predictive_moments:</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># predictive moments 10 weeks ahead:</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>pred_mom7 <span class="ot">&lt;-</span> <span class="fu">predictive_moments</span>(fit7, <span class="at">t_condition =</span> <span class="fu">max</span>(subset_fit), <span class="at">lgt =</span> <span class="dv">10</span>)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="co"># print some predictive means:</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pred_mom7<span class="sc">$</span>mu_matrix[, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           chwi     frkr      lich     mahe      mitt     neuk
t=313 10.143891 5.997015  8.315079 7.550797 12.276676 9.072281
t=314 10.256036 6.200316  9.202886 7.794306 11.403386 9.483784
t=315 10.224376 6.285932  9.759873 7.944234 10.889366 9.757613
t=316 10.077085 6.281429 10.044002 7.998614 10.518741 9.877621
t=317  9.833192 6.199311 10.132328 7.930412 10.185662 9.836843
t=318  9.529173 6.051469 10.026521 7.766129  9.843626 9.705029</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot:</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit7)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="fu">fanplot_prediction</span>(pred_mom7, <span class="at">add =</span> <span class="cn">TRUE</span>,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.15</span>, <span class="fl">0.25</span>, <span class="fl">0.75</span>, <span class="fl">0.85</span>, <span class="fl">0.95</span>),</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">pt.col =</span> <span class="st">"black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/moments-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># note: the plot is based on a negative binomial approximation of the </span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co"># predictive distributions.</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="co"># stationary/marginal moments are implemented, too (but don't always exist):</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>stat7 <span class="ot">&lt;-</span> <span class="fu">stationary_moments</span>(fit6)</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="fu">fanplot_stationary</span>(stat7, <span class="at">unit =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="multivariate_files/figure-html/moments-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="over-to-you" class="level2">
<h2 class="anchored" data-anchor-id="over-to-you">Over to you…</h2>
<p>You are now invited to perform an analysis of rotavirus in Berlin along the lines of the above. The data, which are structured the same way as the norovirus data. Your “goal” is to formulate a model which will generate good one-step-ahead forecasts (we’ll use <code>logS</code> as the main outcome, which is the so-called logarithmic score, equivalent to the negative predictive log-likelihood). You can load the data via</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"rotaBE"</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co"># if you don't have the hhh4addon package installed you can use:</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># load(</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co"># url("https://github.com/cmmid/hhh4-workshop/blob/main/tutorial2_multivariate/data/rotaBE.rda?raw=true")</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Your code should look somewhat like the following:</p>
<ul>
<li>Look at the data to get an idea of what it looks like.</li>
<li>Formulate and refine a control argument. To imitate a forecasting setting it makes sense to only use observations up to week 312 here (though you’re free to play around with whatever subsets of the data you like).</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>ctrl <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">end =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="fu">addSeason2formula</span>(<span class="sc">~</span><span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>),</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">S =</span> <span class="dv">1</span>)),</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">ar =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> <span class="st">"NegBin1"</span>,</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">subset =</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">312</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Fit the model using <code>hhh4</code> or <code>profile_par_lag</code>.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>your_fit <span class="ot">&lt;-</span> <span class="fu">hhh4</span>(rotaBE, ctrl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Run the following (remove comments:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># owa &lt;- oneStepAhead(your_fit, tp = c(312, 363))</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="co"># or: owa &lt;- oneStepAhead_hhh4(your_fit, tp = c(312, 363))</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="co"># if you have used profile_par_lag </span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># colMeans(scores(owa), which = c("logs", "rps"))</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     logs       rps</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.931189  1.639351</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you like you can post your results here (https://github.com/cmmid/hhh4-workshop/issues/1) or on the chat.</p>
<p>Here are some model aspects you can play around with:</p>
<ul>
<li>Higher-order seasonal terms (as in a Fourier series) can be included by setting <code>S = 2</code> or higher in the <code>addSeason2formula</code> function.</li>
<li>Linear time trends can be included by adding <code>+ t</code> to a formula, e.g.&nbsp;<code>f = addSeason2formula($\sim$ 0 + t + fe(1, unitSpecific = TRUE), S = 1)</code></li>
<li>Rotavirus transmission is known to be linked to temperature (https://doi.org/10.1098/rspb.2009.1755). We therefore uploaded a time series of weekly mean temperature values in Berlin (average of daily temperatures at 2pm, lagged by one week) to the GitHub repo of the workshop. These (or a transformation) can be used a a covariate.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get temperature data:</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>data_temperature <span class="ot">&lt;-</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="fu">paste0</span>(<span class="st">"https://raw.githubusercontent.com/cmmid/hhh4-workshop/"</span>, </span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"main/tutorial2_multivariate/data/temperature_berlin.csv"</span>))</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>temperature <span class="ot">&lt;-</span> data_temperature<span class="sc">$</span>temperature7d</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="co"># your formula could look as follows:</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>ctrl <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">end =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="fu">addSeason2formula</span>(<span class="sc">~</span><span class="dv">0</span> <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>),</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">S =</span> <span class="dv">1</span>)),</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">ar =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> temperature <span class="sc">+</span> <span class="fu">fe</span>(<span class="dv">1</span>, <span class="at">unitSpecific =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> <span class="st">"NegBin1"</span>,</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">subset =</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">312</span>)</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="co"># though that is not necessarily a very smart way of using the covariate</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>