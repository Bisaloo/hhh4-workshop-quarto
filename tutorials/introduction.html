<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.415">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sebastian Meyer">
<meta name="dcterms.date" content="2022-03-23">

<title>hhh4 workshop - Tutorial 1: “sts” class and univariate hhh4()</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">hhh4 workshop</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">Home</a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="button" data-bs-toggle="dropdown" aria-expanded="false">Tutorials</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../tutorials/introduction.html">
 <span class="dropdown-text">Tutorial 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/multivariate.html">
 <span class="dropdown-text">Tutorial 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/covariate.qmd">
 <span class="dropdown-text">Tutorial 3</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-applications" role="button" data-bs-toggle="dropdown" aria-expanded="false">Applications</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-applications">    
        <li>
    <a class="dropdown-item" href="../applications/session1.html">
 <span class="dropdown-text">Session 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../applications/session2.html">
 <span class="dropdown-text">Session 2</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/bisaloo/hhh4-workshop-quarto"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Tutorial 1: “sts” class and univariate hhh4()</h1>
<p class="subtitle lead">Using data from the ECDC Surveillance Atlas of Infectious Diseases</p>
</div>





<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sebastian Meyer </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 23, 2022</p>
    </div>
  </div>
    
  </div>
  

</header>

<p>This tutorial illustrates how to import time series data as an <code>"sts"</code> (surveillance time series) object as used by the R package <a href="https://CRAN.R-project.org/package=surveillance"><strong>surveillance</strong></a>. As an example, we will import a <a href="data/ECDC_surveillance_data_IMD.csv.gz">(gzip-compressed) csv file</a> downloaded from the <a href="https://atlas.ecdc.europa.eu/">ECDC Surveillance Atlas of Infectious Diseases</a>. It contains the monthly number of reported cases of invasive meningococcal disease (IMD).</p>
<p>The code to import the raw data is already provided here and in the <a href="template.R">R script template</a> so that you don’t lose time with this step and can concentrate on the <code>sts()</code> and <code>hhh4()</code> exercises further below.</p>
<p>Before you start, here is what <a href="https://en.wikipedia.org/wiki/Neisseria_meningitidis#Epidemiology">Wikipedia</a> says about the epidemiology of meningococcus, the bacterium causing IMD:</p>
<blockquote class="blockquote">
<p>It is spread through saliva and other respiratory secretions during coughing, sneezing, kissing, and chewing on toys. Inhalation of respiratory droplets from a carrier which may be someone who is themselves in the early stages of disease can transmit the bacteria. […] The incubation period is short, from 2 to 10 days.</p>
</blockquote>
<section id="import-count-time-series" class="level2">
<h2 class="anchored" data-anchor-id="import-count-time-series">Import count time series</h2>
<p>This is how the first 3 lines of the csv file from ECDC look like:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code>"HealthTopic","Population","Indicator","Unit","Time","RegionCode","RegionName","NumValue","TxtValue"
"Invasive meningococcal disease","Confirmed cases","Reported cases","N","1999-01","AT","Austria",11.000000000,""
"Invasive meningococcal disease","Confirmed cases","Reported cases","N","1999-01","BE","Belgium",24.000000000,""</code></pre>
</div>
</div>
<details>
<summary>
Disclaimer (ECDC)
</summary>
The views and opinions of the authors expressed herein do not necessarily state or reflect those of the ECDC. The accuracy of the authors’ statistical analysis and the findings they report are not the responsibility of ECDC. ECDC is not responsible for conclusions or opinions drawn from the data provided. ECDC is not responsible for the correctness of the data and for data management, data merging and data collation after provision of the data. ECDC shall not be held liable for improper or incorrect use of the data.
</details>
<p>The first step is to import the counts from the csv file and reshape the data into the wide (matrix) format typically used for multivariate time series and expected by <code>sts()</code> and basic <code>ts()</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ecdc_long <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/ECDC_surveillance_data_IMD.csv.gz"</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na.strings =</span> <span class="st">"-"</span>) <span class="co"># always important to know NA encoding!</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="do">## exclude aggregate counts</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ecdc_long <span class="ot">&lt;-</span> <span class="fu">subset</span>(ecdc_long, <span class="sc">!</span>RegionName <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"EU/EEA"</span>, <span class="st">"EU"</span>))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="do">## reshape from long to wide format of multivariate time series</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>ecdc <span class="ot">&lt;-</span> <span class="fu">reshape</span>(ecdc_long[<span class="fu">c</span>(<span class="st">"Time"</span>, <span class="st">"RegionCode"</span>, <span class="st">"NumValue"</span>)],</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">direction =</span> <span class="st">"wide"</span>, <span class="at">idvar =</span> <span class="st">"Time"</span>, <span class="at">timevar =</span> <span class="st">"RegionCode"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ecdc) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"NumValue."</span>, <span class="st">""</span>, <span class="fu">names</span>(ecdc), <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(ecdc) <span class="ot">&lt;-</span> ecdc<span class="sc">$</span>Time; ecdc<span class="sc">$</span>Time <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ecdc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        AT BE CZ DE DK EE EL  ES FI FR IE IS IT LU MT NL NO PL SE SI  UK LT PT LV HU SK CY BG RO HR
1999-01 11 24  5 37 19  0 18 172  6 43 53  2 36  0  0 81  4 11  2  1 495 NA NA NA NA NA NA NA NA NA
1999-02 14 37  8 48 17  0 16 123  9 65 43  2 31  0  2 68 11  9  3  0 267 NA NA NA NA NA NA NA NA NA
1999-03 12 49 11 54 28  0 42  90  5 35 53  1 29  0  3 82 10  8  6  0 224 NA NA NA NA NA NA NA NA NA
1999-04  6 23  9 36 22  1 21  70  3 30 40  2 23  0  0 33  4  4  2  1 203 NA NA NA NA NA NA NA NA NA
1999-05  3 27 14 36 11  0 16  78  7 18 34  2 18  0  1 41  6  6  3  1 140 NA NA NA NA NA NA NA NA NA
1999-06  4 25 10 30 12  0 11  50  8 19 24  2 21  0  1 38  4  1  2  0 199 NA NA NA NA NA NA NA NA NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(ecdc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        AT BE CZ DE DK EE EL ES FI FR IE IS IT LU MT NL NO PL SE SI UK LT PT LV HU SK CY BG RO HR
2018-07  1 10  8 18  5  1  2 25  1 34  5  0 12 NA  0 16  2  7  6  1 28  1  5  0  0  2  0 NA  3 NA
2018-08  4  1  7 15  1  0  3 13  1 17  5  0  8 NA  1 13  1  8  2  0 32  1  4  0  0  2  0 NA  6 NA
2018-09  1  5  0 14  0  0  1 22  2 17  7  0  7 NA  0  7  1  4  6  2 44  2  1  1  4  0  0 NA  4 NA
2018-10  2 13  3 27  4  0  2 32  3 30  4  0 12 NA  0 21  3 18  6  2 57  1  3  1  2  5  0 NA  6 NA
2018-11  3  6  7 15  3  0  4 26  0 28  4  0 10 NA  0 10  0 21  1  2 44  1  5  0  3  1  0 NA  2 NA
2018-12  1  9  7 17  3  0  4 34  1 47  6  0 10 NA  0 13  2 21  7  3 60  3  5  1  6  2  0 NA  4 NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## exclude contries without data</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ecdc <span class="ot">&lt;-</span> ecdc[, <span class="fu">colSums</span>(<span class="sc">!</span><span class="fu">is.na</span>(ecdc)) <span class="sc">&gt;</span> <span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Country codes are given in the <a href="https://ec.europa.eu/eurostat/statistics-explained/index.php?title=Glossary:Country_codes">Eurostat Glossary</a>.</p>
</section>
<section id="import-population-data" class="level2">
<h2 class="anchored" data-anchor-id="import-population-data">Import population data</h2>
<p>Population counts are needed to calculate incidence values. <a href="https://ec.europa.eu/eurostat/">Eurostat</a> provides such data as table “TPS00001”; we have downloaded the values for 2018 as a csv file.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>popdata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/Eurostat_population_2018.csv"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(popdata, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             DATAFLOW       LAST.UPDATE freq indic_de geo TIME_PERIOD OBS_VALUE OBS_FLAG
1 ESTAT:TPS00001(1.0) 17/03/22 23:00:00    A      JAN  AD        2018     74794        e
2 ESTAT:TPS00001(1.0) 17/03/22 23:00:00    A      JAN  AL        2018   2870324         
3 ESTAT:TPS00001(1.0) 17/03/22 23:00:00    A      JAN  AM        2018   2972732         </code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">colnames</span>(ecdc) <span class="sc">%in%</span> popdata<span class="sc">$</span>geo)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>pop <span class="ot">&lt;-</span> <span class="fu">setNames</span>(popdata<span class="sc">$</span>OBS_VALUE, popdata<span class="sc">$</span>geo)[<span class="fu">colnames</span>(ecdc)]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>pop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      AT       BE       CZ       DE       DK       EE       EL       ES       FI       FR       IE 
 8822267 11398589 10610055 82792351  5781190  1319133 10741165 46658447  5513130 67026224  4830392 
      IS       IT       LU       MT       NL       NO       PL       SE       SI       UK       LT 
  348450 60483973   602005   475701 17181084  5295619 37976687 10120242  2066880 66273576  2808901 
      PT       LV       HU       SK       CY       RO 
10291027  1934379  9778371  5443120   864236 19533481 </code></pre>
</div>
</div>
</section>
<section id="import-map" class="level2">
<h2 class="anchored" data-anchor-id="import-map">Import map</h2>
<p>The <code>"sts"</code> class can be used without a supplementary map, but incorporating one enables a spatial view of the data. We retrieve a suitable GeoJSON dataset of administrative boundaries from <a href="https://gisco-services.ec.europa.eu/distribution/v2/nuts/nuts-2021-files.html">Eurostat/GISCO</a>, with Copyright (C) EuroGeographics. The result of importing that dataset is available as <a href="data/map.RData">map.RData</a> (so as to avoid potential problems with system requirements for <strong>sf</strong>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>file_map <span class="ot">&lt;-</span> <span class="st">"data/map.RData"</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(file_map)) {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">load</span>(file_map)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"sf"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## read NUTS1-level data from Eurostat/GISCO</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  map1 <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_60M_2021_4326_LEVL_1.geojson"</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## omit French overseas regions for a more compact map</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  map1 <span class="ot">&lt;-</span> <span class="fu">subset</span>(map1, NUTS_ID <span class="sc">!=</span> <span class="st">"FRY"</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## union polygons by country</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  map0 <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(map1[<span class="dv">0</span>], <span class="at">by =</span> <span class="fu">list</span>(<span class="at">COUNTRY =</span> map1<span class="sc">$</span>CNTR_CODE), <span class="at">FUN =</span> sum)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## check that the map contains the country codes of colnames(ecdc)</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">colnames</span>(ecdc) <span class="sc">%in%</span> map0<span class="sc">$</span>COUNTRY)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## convert to "SpatialPolgons" for use with sts()</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">row.names</span>(map0) <span class="ot">&lt;-</span> map0<span class="sc">$</span>COUNTRY  <span class="co"># to match with colnames(ecdc)</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"sp"</span>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  map <span class="ot">&lt;-</span> <span class="fu">geometry</span>(<span class="fu">as_Spatial</span>(map0))</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(map, <span class="at">file =</span> file_map, <span class="at">compress =</span> <span class="st">"xz"</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-fig.crop="true">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"sp"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(map)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/map_plot-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="create-an-sts-object" class="level2">
<h2 class="anchored" data-anchor-id="create-an-sts-object">Create an “sts” object</h2>
<p>Using the above ingredients (<code>ecdc</code>, <code>pop</code>, <code>map</code>), we can now create an <code>"sts"</code> object via <code>sts()</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"surveillance"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="do">## start of the monthly time series</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>(start <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">strsplit</span>(<span class="fu">rownames</span>(ecdc)[<span class="dv">1</span>], <span class="at">split=</span><span class="st">"-"</span>)[[<span class="dv">1</span>]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1999    1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">## IMD0 &lt;- sts(....)  # see help("sts")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<details>
<summary>
solution
</summary>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>IMD0 <span class="ot">&lt;-</span> <span class="fu">sts</span>(ecdc, <span class="at">start =</span> start, <span class="at">frequency =</span> <span class="dv">12</span>, <span class="co"># monthly data</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">population =</span> pop, <span class="at">map =</span> map)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<hr>
<p>Plot the (aggregated) count time series. Which problem do you notice?</p>
<details>
<summary>
solution
</summary>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(IMD0, <span class="at">type =</span> observed <span class="sc">~</span> time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">## the time series obviously contains missing values</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="do">## ggplot2 version:</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot.sts</span>(<span class="fu">aggregate</span>(IMD0, <span class="at">by =</span> <span class="st">"unit"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 227 rows containing missing values (position_stack).</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</details>
<hr>
<p>To keep things simple, we restrict the remaining exercises to a subset of the countries:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>IMD <span class="ot">&lt;-</span> IMD0[, <span class="fu">grep</span>(<span class="st">"^[ADFNU]"</span>, <span class="fu">colnames</span>(IMD0))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualizations" class="level2">
<h2 class="anchored" data-anchor-id="visualizations">Visualizations</h2>
<section id="observed-time" class="level3">
<h3 class="anchored" data-anchor-id="observed-time">observed ~ time</h3>
<p>Plot the overall and country-specific count time series, using either the conventional plot method or <code>autoplot.sts()</code> (requires <strong>ggplot2</strong>). The latter has an argument to plot incidences instead of counts.</p>
<details>
<summary>
solution
</summary>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">## count time series</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(IMD, <span class="at">type =</span> observed <span class="sc">~</span> time)  <span class="co"># overall</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(IMD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-5-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot.sts</span>(IMD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-5-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="do">## incidence time series (per 100'000 inhabitants)</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot.sts</span>(IMD, <span class="at">population =</span> <span class="dv">100000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-5-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</details>
<hr>
</section>
<section id="observed-unit" class="level3">
<h3 class="anchored" data-anchor-id="observed-unit">observed ~ unit</h3>
<p>Produce a map with the country-specific cumulative number of cases (or incidence) over time. See <code>help("stsplot_space")</code> for options.</p>
<details>
<summary>
solution
</summary>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(IMD, <span class="at">type =</span> observed <span class="sc">~</span> unit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">## cumulative incidence (per 100'000 inhabitants),</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="do">## using some of the graphical options</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(IMD, <span class="at">type =</span> observed <span class="sc">~</span> unit, <span class="at">population =</span> <span class="dv">100000</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">col.regions =</span> <span class="fu">hcl.colors</span>(<span class="dv">100</span>, <span class="at">rev =</span> <span class="cn">TRUE</span>),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">gpar.missing =</span> <span class="fu">list</span>(<span class="at">lty =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="dv">8</span>),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">sub =</span> <span class="st">"cumulative incidence (per 100'000 inhabitants)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</details>
<hr>
</section>
<section id="plot-via-conversion-to-other-data-classes" class="level3">
<h3 class="anchored" data-anchor-id="plot-via-conversion-to-other-data-classes">Plot via conversion to other data classes</h3>
<p><code>"sts"</code> objects can be converted to</p>
<ul>
<li><p>the basic <code>"ts"</code> class via <code>as.ts()</code>,</p></li>
<li><p>the <a href="https://CRAN.R-project.org/package=xts"><strong>xts</strong></a> format via <code>as.xts.sts()</code>,</p></li>
<li><p>a “tidy” (long) <code>data.frame</code> via <code>tidy.sts()</code> that can be used as input for, e.g., <a href="https://CRAN.R-project.org/package=ggplot2"><strong>ggplot2</strong></a> or <a href="https://CRAN.R-project.org/package=lattice"><strong>lattice</strong></a>.</p></li>
</ul>
<p>Try to produce some alternative plots of the time series.</p>
<details>
<summary>
solution
</summary>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="do">## basic "ts"</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.ts</span>(IMD), <span class="at">las =</span> <span class="dv">1</span>, <span class="at">type =</span> <span class="st">"h"</span>)  <span class="co"># note the varying y-axes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="do">## "xts"</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"xts"</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.xts</span>(IMD), <span class="at">multi.panel =</span> <span class="cn">TRUE</span>, <span class="at">yaxis.same =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="do">## "lattice"</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(IMDDF <span class="ot">&lt;-</span> <span class="fu">tidy.sts</span>(IMD))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   1920 obs. of  12 variables:
 $ epoch        : int  1 2 3 4 5 6 7 8 9 10 ...
 $ unit         : Factor w/ 8 levels "AT","DE","DK",..: 1 1 1 1 1 1 1 1 1 1 ...
 $ year         : num  1999 1999 1999 1999 1999 ...
 $ freq         : num  12 12 12 12 12 12 12 12 12 12 ...
 $ epochInYear  : num  1 2 3 4 5 6 7 8 9 10 ...
 $ epochInPeriod: num  0.0833 0.1667 0.25 0.3333 0.4167 ...
 $ date         : Date, format: "1999-01-01" "1999-02-01" "1999-03-01" ...
 $ observed     : num  11 14 12 6 3 4 4 7 9 3 ...
 $ state        : logi  FALSE FALSE FALSE FALSE FALSE FALSE ...
 $ alarm        : logi  NA NA NA NA NA NA ...
 $ upperbound   : num  NA NA NA NA NA NA NA NA NA NA ...
 $ population   : int  8822267 8822267 8822267 8822267 8822267 8822267 8822267 8822267 8822267 8822267 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"lattice"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">xyplot</span>(observed <span class="sc">~</span> date <span class="sc">|</span> unit, <span class="at">data =</span> IMDDF, <span class="at">type =</span> <span class="st">"h"</span>, <span class="at">as.table =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-7-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="do">## "ggplot2"</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(IMDDF, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed)) <span class="sc">+</span> <span class="fu">geom_col</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span> unit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-7-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</details>
<hr>
</section>
</section>
<section id="univariate-hhh4-modelling-exercise" class="level2">
<h2 class="anchored" data-anchor-id="univariate-hhh4-modelling-exercise">Univariate <code>hhh4()</code> modelling exercise</h2>
<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction">Introduction</h3>
<p>We will now estimate simple, univariate <code>hhh4()</code> models for the IMD time series from France:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>IMD1 <span class="ot">&lt;-</span> IMD[,<span class="st">"FR"</span>]</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(IMD1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/IMD1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="do">## plot yearly time series to investigate seasonality, here using "lattice"</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"lattice"</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">xyplot</span>(observed <span class="sc">~</span> <span class="fu">factor</span>(epochInYear), <span class="at">data =</span> <span class="fu">tidy.sts</span>(IMD1),</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">groups =</span> year, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">xlab =</span> <span class="st">"month"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/IMD1-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Seasonality can be captured by including transformations of time (sine-cosine terms) as covariates in the model.</p>
<p>With monthly data, we will miss some of the infection dynamics and essentially aggregate over two generations. On the other hand, including a single lag as in the original formulation of the observation-driven <code>hhh4</code> model seems sufficient.</p>
<p>In statistical terms, we will fit simple models of the form</p>
<p><span class="math display">\[
Y_t | Y_{t-1} \sim \operatorname{NegBin}(\lambda_t y_{t-1} + \nu_t, \phi)
\]</span></p>
<p>where the log-linear predictors <span class="math inline">\(\lambda_t\)</span> (<code>ar</code>) and <span class="math inline">\(\nu_t\)</span> (<code>end</code>) could both use the regression formula</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">addSeason2formula</span>(<span class="sc">~</span> t, <span class="at">S =</span> s, <span class="at">period =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>with <code>s</code> being the number of harmonics (each harmonic needing two parameters, amplitude and shift). In mathematical notation, this amounts to log-linear predictors of the form</p>
<p><span class="math display">\[
\alpha + \beta t +
\sum_{s=1}^S \left\{ \gamma_s \sin(s \omega t) +
                     \delta_s \cos(s \omega t) \right\}
\]</span></p>
<p>with fundamental frequency <span class="math inline">\(\omega=2\pi/12\)</span>.</p>
</section>
<section id="tasks" class="level3">
<h3 class="anchored" data-anchor-id="tasks">Tasks</h3>
<ol type="1">
<li>Estimate a few <code>hhh4()</code> models of the above form (with or without trend) and compare them using <code>AIC()</code> (Akaike Information Criterion). Note that you can easily estimate a new model with an updated number of harmonics and dropped AR trend from a previous model fit:</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">update</span>(fit1, <span class="at">ar =</span> <span class="fu">list</span>(<span class="at">f =</span> <span class="sc">~</span> <span class="dv">1</span>), <span class="at">S =</span> <span class="fu">list</span>(<span class="at">ar =</span> <span class="dv">2</span>, <span class="at">end =</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li><p>Plot the fitted time series and the estimated seasonal curves of one or more useful models.</p></li>
<li><p>Use <code>oneStepAhead()</code> to run rolling monthly forecasts over the last two years and <code>plot()</code> the result. You could also look at a <code>pit()</code> histogram of these probabilistic forecasts.</p></li>
</ol>
<details>
<summary>
solution
</summary>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="do">## model 1 with time trend and single sinusoidal curve in both components</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>(form1 <span class="ot">&lt;-</span> <span class="fu">addSeason2formula</span>(<span class="sc">~</span>t, <span class="at">S =</span> <span class="dv">1</span>, <span class="at">period =</span> <span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>~t + sin(2 * pi * t/12) + cos(2 * pi * t/12)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">hhh4</span>(IMD1, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">ar =</span> <span class="fu">list</span>(<span class="at">f =</span> form1),</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">end =</span> <span class="fu">list</span>(<span class="at">f =</span> form1),</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">family =</span> <span class="st">"NegBin1"</span>))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: 
hhh4(stsObj = IMD1, control = list(ar = list(f = form1), end = list(f = form1), 
    family = "NegBin1"))

Coefficients:
                        Estimate    Std. Error
ar.1                    -0.9109893   0.2132560
ar.t                    -0.0008338   0.0010388
ar.sin(2 * pi * t/12)    0.0150849   0.1525758
ar.cos(2 * pi * t/12)   -0.2375763   0.1751476
end.1                    3.3798524   0.1314850
end.t                   -0.0003699   0.0005889
end.sin(2 * pi * t/12)   0.0558467   0.0890148
end.cos(2 * pi * t/12)   0.4992783   0.1029933
overdisp                 0.0304332   0.0047301

Log-likelihood:   -895.61 
AIC:              1809.22 
BIC:              1840.5 

Number of units:        1 
Number of time points:  239 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="do">## for parameter interpretation:</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1, <span class="at">maxEV =</span> <span class="cn">TRUE</span>, <span class="at">amplitudeShift =</span> <span class="cn">TRUE</span>, <span class="at">idx2Exp =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: 
hhh4(stsObj = IMD1, control = list(ar = list(f = form1), end = list(f = form1), 
    family = "NegBin1"))

Coefficients:
                      Estimate    Std. Error
exp(ar.1)              0.4021262   0.0857558
exp(ar.t)              0.9991665   0.0010379
ar.A(2 * pi * t/12)    0.2380547   0.1787364
ar.s(2 * pi * t/12)   -1.5073863   0.0972142
exp(end.1)            29.3664369   3.8612452
exp(end.t)             0.9996302   0.0005887
end.A(2 * pi * t/12)   0.5023919   0.0978861
end.s(2 * pi * t/12)   1.4594044   0.0612924
overdisp               0.0304332   0.0047301

Epidemic dominant eigenvalue:  0.26 -- 0.51 

Log-likelihood:   -895.61 
AIC:              1809.22 
BIC:              1840.5 

Number of units:        1 
Number of time points:  239 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="do">## model 2 without time trends</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>form2 <span class="ot">&lt;-</span> <span class="fu">addSeason2formula</span>(<span class="sc">~</span><span class="dv">1</span>, <span class="at">S =</span> <span class="dv">1</span>, <span class="at">period =</span> <span class="dv">12</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">hhh4</span>(IMD1, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">ar =</span> <span class="fu">list</span>(<span class="at">f =</span> form2),</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">end =</span> <span class="fu">list</span>(<span class="at">f =</span> form2),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">family =</span> <span class="st">"NegBin1"</span>))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2, <span class="at">maxEV =</span> <span class="cn">TRUE</span>, <span class="at">amplitudeShift =</span> <span class="cn">TRUE</span>, <span class="at">idx2Exp =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: 
hhh4(stsObj = IMD1, control = list(ar = list(f = form2), end = list(f = form2), 
    family = "NegBin1"))

Coefficients:
                      Estimate   Std. Error
exp(ar.1)              0.399107   0.064866 
ar.A(2 * pi * t/12)    0.219542   0.153981 
ar.s(2 * pi * t/12)   -1.524598   0.091334 
exp(end.1)            26.530592   2.917682 
end.A(2 * pi * t/12)   0.521711   0.101092 
end.s(2 * pi * t/12)   1.475408   0.063261 
overdisp               0.031759   0.004843 

Epidemic dominant eigenvalue:  0.32 -- 0.50 

Log-likelihood:   -898.38 
AIC:              1810.75 
BIC:              1835.09 

Number of units:        1 
Number of time points:  239 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(fit1, fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     df      AIC
fit1  9 1809.216
fit2  7 1810.753</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="do">## model 3 with two harmonics</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">update</span>(fit2, <span class="at">S =</span> <span class="fu">list</span>(<span class="at">ar =</span> <span class="dv">2</span>, <span class="at">end =</span> <span class="dv">2</span>))</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(fit2, fit3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     df      AIC
fit2  7 1810.753
fit3 11 1802.036</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="do">## fitted values and estimated seasonality</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit3, <span class="at">type =</span> <span class="st">"season"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="do">## compute rolling monthly forecasts</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>osa <span class="ot">&lt;-</span> <span class="fu">oneStepAhead</span>(fit3, <span class="fu">nrow</span>(IMD1) <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span><span class="dv">52</span>, <span class="at">verbose =</span> <span class="fu">interactive</span>())</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(osa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-8-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">quantile</span>(osa))  <span class="co"># for prediction intervals</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2.5 % 10.0 % 50.0 % 90.0 % 97.5 %
137    24     29     39     52     59
138    22     27     37     48     55
139    25     30     41     54     61
140    21     26     36     47     54
141    19     23     33     43     49
142    24     29     40     52     59</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pit</span>(osa)  <span class="co"># model tends to overpredict</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="introduction_files/figure-html/unnamed-chunk-8-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</details>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>